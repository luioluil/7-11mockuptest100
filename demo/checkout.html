<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ชำระเงิน - 7-Delivery Demo</title>
  <link rel="stylesheet" href="styles/main.css" />
  <style>
    /* สไตล์เฉพาะหน้านี้ */
    body{background:#f6f7f8}
    .page{max-width:960px;margin:0 auto;padding:16px;}
    .section{background:#fff;border-radius:16px;box-shadow:0 6px 16px #00000014;margin-bottom:16px}
    .section>h3{padding:16px 16px 0}
    .section>div{padding:16px}
    .grid-2{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:900px){.grid-2{grid-template-columns:1.2fr .8fr}}
    .field{margin-bottom:12px}
    .field label{display:block;font-size:14px;color:#333;margin-bottom:6px}
    .field input,.field textarea{width:100%;padding:12px 14px;border:1px solid #e6e6e6;border-radius:12px;outline:none}
    .field textarea{min-height:96px;resize:vertical}
    .pay-opt{display:flex;flex-direction:column;gap:10px}
    .radio{display:flex;align-items:center;gap:10px;padding:12px;border:1px solid #e6e6e6;border-radius:12px}
    .radio.disabled{opacity:.6}
    .chip{display:inline-flex;align-items:center;border-radius:999px;padding:4px 10px;font-size:12px;border:1px solid #ddd;color:#666;margin-left:6px}
    .soon{background:#f5f5f5;border-color:#eee;color:#999}
    .summary-list{display:flex;flex-direction:column;gap:10px}
    .sum-row{display:flex;justify-content:space-between;gap:10px}
    .sum-note{font-size:12px;color:#666}
    .total{font-weight:700;font-size:18px}
    .btn-row{display:flex;gap:10px}
    .btn{display:inline-flex;justify-content:center;align-items:center;padding:12px 16px;border-radius:12px;border:1px solid #e6e6e6;background:#fff;cursor:pointer}
    .btn.primary{background:#0a7b34;color:#fff;border-color:#0a7b34}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    header.appbar{height:56px;background:#0a7b34;color:#fff;display:flex;align-items:center;padding:0 14px;gap:10px}
    header.appbar a{color:#fff;text-decoration:none}
  </style>
</head>
<body>
  <header class="appbar">
    <a href="index.html" aria-label="back">←</a>
    <div>ชำระเงิน</div>
  </header>

  <main class="page">
    <div class="grid-2">
      <!-- ซ้าย: ฟอร์มที่อยู่ -->
      <section class="section">
        <h3>ที่อยู่จัดส่ง</h3>
        <div>
          <div class="field">
            <label>ชื่อ-นามสกุล *</label>
            <input id="nameInput" placeholder="เช่น ก้องดา ศนุชาบินเวลา" />
          </div>
          <div class="field">
            <label>เบอร์โทร *</label>
            <input id="phoneInput" placeholder="เช่น 08xxxxxxxx" inputmode="numeric" />
          </div>
          <div class="field">
            <label>ที่อยู่ *</label>
            <textarea id="addrInput" placeholder="บ้านเลขที่/อาคาร/ชั้น/ตรอก/ซอย/แขวง/เขต/จังหวัด/รหัสไปรษณีย์"></textarea>
          </div>
          <div class="field">
            <label>หมายเหตุถึงไรเดอร์ (ถ้ามี)</label>
            <input id="noteInput" placeholder="เช่น ฝากวางหน้าประตู" />
          </div>
          <div class="btn-row">
            <button id="useSaved" class="btn">ใช้ที่อยู่เดิม</button>
          </div>
        </div>
      </section>

      <!-- ขวา: สรุปรายการ -->
      <section class="section">
        <h3>สรุปรายการ</h3>
        <div>
          <div id="sumList" class="summary-list"></div>
          <hr style="border:none;border-top:1px solid #eee;margin:12px 0" />
          <div class="sum-row"><div>ค่าส่ง</div><div id="shipFee">฿0</div></div>
          <div class="sum-row total"><div>ยอดสุทธิ</div><div id="grandTotal">฿0</div></div>
        </div>
      </section>
    </div>

    <!-- วิธีชำระเงิน -->
    <section class="section">
      <h3>วิธีชำระเงิน</h3>
      <div>
        <div class="pay-opt">
          <label class="radio"><input type="radio" name="pay" value="cod" checked /> เก็บเงินปลายทาง (COD)</label>
          <label class="radio disabled"><input type="radio" name="pay" value="wallet" disabled /> TrueMoney Wallet <span class="chip soon">Coming soon</span></label>
          <label class="radio disabled"><input type="radio" name="pay" value="transfer" disabled /> โอนเงิน <span class="chip soon">Coming soon</span></label>
          <label class="radio disabled"><input type="radio" name="pay" value="points" disabled /> ใช้แต้ม <span class="chip soon">Coming soon</span></label>
        </div>
      </div>
    </section>

    <div class="btn-row" style="justify-content:flex-end">
      <a href="index.html" class="btn">กลับไปซื้อเพิ่ม</a>
      <button id="confirmBtn" class="btn primary" disabled>ยืนยันคำสั่งซื้อ</button>
    </div>
  </main>

  <script>
    // ====== Checkout Logic ======
    const $ = (s) => document.querySelector(s);
    const $$ = (s) => Array.from(document.querySelectorAll(s));

    const ADDR_KEY = 'checkoutAddress';
    const cart = JSON.parse(localStorage.getItem('cart') || '[]');

    // ถ้าตะกร้าว่าง กลับหน้าแรก
    if (!cart.length) window.location.href = 'index.html';

    // ใช้ที่อยู่เดิม (ถ้ามี)
    const saved = JSON.parse(localStorage.getItem(ADDR_KEY) || 'null');
    if (saved) {
      $('#useSaved').addEventListener('click', () => {
        $('#nameInput').value = saved.name || '';
        $('#phoneInput').value = saved.phone || '';
        $('#addrInput').value = saved.addr || '';
        $('#noteInput').value = saved.note || '';
        validate();
      });
    } else {
      $('#useSaved').disabled = true;
    }

    // แสดงสรุปรายการจาก localStorage.cart
    function money(n){ return '฿' + n; }
    function renderSummary(){
      const list = $('#sumList');
      list.innerHTML = '';
      let total = 0;
      cart.forEach(it => {
        const opts = [it.heat, it.sauce, ...(it.addons || [])].filter(Boolean).join(' · ');
        const row = document.createElement('div');
        row.className = 'sum-row';
        row.innerHTML = `<div>
            <div><strong>${it.name}</strong> x${it.qty}</div>
            ${opts ? `<div class="sum-note">${opts}</div>` : ``}
          </div>
          <div>${money(it.price * it.qty)}</div>`;
        list.appendChild(row);
        total += it.price * it.qty;
      });
      $('#shipFee').textContent = money(0); // mock: ส่งฟรี
      $('#grandTotal').textContent = money(total);
    }
    renderSummary();

    // ตรวจความครบถ้วนของฟอร์ม + วิธีชำระเงิน
    function validate(){
      const name = $('#nameInput').value.trim();
      const phone = $('#phoneInput').value.trim();
      const addr  = $('#addrInput').value.trim();

      const checked = $$('#input[name="pay"]').find(r => r.checked) // เผื่อพิมพ์ผิด selector
                      || $$('#input[name=pay]').find(r => r.checked)
                      || $$('#input[type="radio"][name="pay"]').find(r => r.checked)
                      || document.querySelector('input[name="pay"]:checked');

      const pay = checked ? checked.value : '';
      const ok = name && addr && /^[0-9]{9,11}$/.test(phone) && pay === 'cod';
      $('#confirmBtn').disabled = !ok;
    }

    // ผูกอีเวนต์ให้ฟอร์ม
    ['#nameInput', '#phoneInput', '#addrInput'].forEach(sel => {
      $(sel).addEventListener('input', validate);
    });
    $$('#input[name="pay"], input[name="pay"]').forEach(r => {
      r.addEventListener('change', validate);
    });
    validate();

    // ยืนยันคำสั่งซื้อ → บันทึกที่อยู่ → ไปหน้า delivery
    $('#confirmBtn').addEventListener('click', () => {
      const data = {
        name: $('#nameInput').value.trim(),
        phone: $('#phoneInput').value.trim(),
        addr : $('#addrInput').value.trim(),
        note : $('#noteInput').value.trim(),
        pay  : 'cod'
      };
      localStorage.setItem(ADDR_KEY, JSON.stringify(data));
      localStorage.setItem('lastTotal', $('#grandTotal').textContent);
      window.location.href = 'delivery.html';
    });
  </script>
</body>
</html>
